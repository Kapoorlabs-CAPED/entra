"""
Plot Optimization Results

Plots the optimization history from CSV files generated by covariance_optimization_demo.py.
Can plot a single sigma or overlay all sigmas on one plot.

Usage:
    python plot_optimization_results.py <csv_file> [--output <output_file>]
    python plot_optimization_results.py --all <combined_csv> [--output <output_file>]
    python plot_optimization_results.py --summary <summary_csv> [--output <output_file>]
"""

import argparse

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd


def plot_single_sigma(csv_file, output_file=None, show=True):
    """Plot optimization history for a single sigma value."""
    df = pd.read_csv(csv_file)

    sigma = df['sigma'].iloc[0]
    target_entropy = df['target_entropy'].iloc[0]

    # Separate Stage 1 and Stage 2
    stage1 = df[df['stage'] == 1]
    stage2 = df[df['stage'] == 2]

    fig, axes = plt.subplots(1, 3, figsize=(15, 4))

    # Plot 1: Determinant (log scale)
    ax0 = axes[0]
    ax0.semilogy(stage1['iteration'], stage1['determinant'], 'b.-', label='Stage 1', markersize=3)
    if len(stage2) > 0:
        # Offset Stage 2 iterations for continuous x-axis
        stage2_offset = stage1['iteration'].max()
        ax0.semilogy(stage2_offset + stage2['iteration'], stage2['determinant'], 'r.-', label='Stage 2', markersize=6)
        ax0.axvline(stage2_offset, color='gray', linestyle='--', alpha=0.5)
    ax0.set_xlabel('Iteration')
    ax0.set_ylabel('Determinant')
    ax0.set_title(f'Determinant (sigma={sigma})')
    ax0.legend()
    ax0.grid(True, alpha=0.3)

    # Plot 2: Gaussian Entropy
    ax1 = axes[1]
    ax1.plot(stage1['iteration'], stage1['gaussian_entropy'], 'b.-', label='Stage 1', markersize=3)
    if len(stage2) > 0:
        stage2_offset = stage1['iteration'].max()
        ax1.plot(stage2_offset + stage2['iteration'], stage2['gaussian_entropy'], 'r.-', label='Stage 2', markersize=6)
        ax1.axvline(stage2_offset, color='gray', linestyle='--', alpha=0.5)
    ax1.axhline(target_entropy, color='green', linestyle='--', linewidth=2, label=f'Target H(uniform)={target_entropy:.4f}')
    ax1.set_xlabel('Iteration')
    ax1.set_ylabel('H(Gaussian) [nats]')
    ax1.set_title(f'Gaussian Entropy (sigma={sigma})')
    ax1.legend()
    ax1.grid(True, alpha=0.3)

    # Plot 3: Gap to Target
    ax2 = axes[2]
    ax2.plot(stage1['iteration'], stage1['gap'], 'b.-', label='Stage 1', markersize=3)
    if len(stage2) > 0:
        stage2_offset = stage1['iteration'].max()
        ax2.plot(stage2_offset + stage2['iteration'], stage2['gap'], 'r.-', label='Stage 2', markersize=6)
        ax2.axvline(stage2_offset, color='gray', linestyle='--', alpha=0.5)
    ax2.axhline(0, color='green', linestyle='--', linewidth=2, label='Target (gap=0)')
    ax2.set_xlabel('Iteration')
    ax2.set_ylabel('Gap [nats]')
    ax2.set_title(f'Gap to Target (sigma={sigma})')
    ax2.legend()
    ax2.grid(True, alpha=0.3)

    plt.tight_layout()

    if output_file:
        plt.savefig(output_file, dpi=150, bbox_inches='tight')
        print(f"Saved: {output_file}")

    if show:
        plt.show()

    return fig


def plot_all_sigmas(combined_csv, output_file=None, show=True):
    """Plot optimization history for all sigma values overlaid."""
    df = pd.read_csv(combined_csv)

    sigmas = sorted(df['sigma'].unique())
    target_entropy = df['target_entropy'].iloc[0]

    # Use colormap
    colors = plt.cm.viridis(np.linspace(0, 1, len(sigmas)))

    fig, axes = plt.subplots(1, 3, figsize=(16, 5))

    for i, sigma in enumerate(sigmas):
        sigma_df = df[df['sigma'] == sigma]

        # Create continuous iteration index
        stage1 = sigma_df[sigma_df['stage'] == 1]
        stage2 = sigma_df[sigma_df['stage'] == 2]

        iters = list(stage1['iteration'])
        dets = list(stage1['determinant'])
        ents = list(stage1['gaussian_entropy'])
        gaps = list(stage1['gap'])

        if len(stage2) > 0:
            offset = stage1['iteration'].max()
            iters.extend([offset + x for x in stage2['iteration']])
            dets.extend(stage2['determinant'])
            ents.extend(stage2['gaussian_entropy'])
            gaps.extend(stage2['gap'])

        # Plot
        axes[0].semilogy(iters, dets, '.-', color=colors[i], label=f'σ={sigma}', markersize=2, alpha=0.8)
        axes[1].plot(iters, ents, '.-', color=colors[i], label=f'σ={sigma}', markersize=2, alpha=0.8)
        axes[2].plot(iters, gaps, '.-', color=colors[i], label=f'σ={sigma}', markersize=2, alpha=0.8)

    # Formatting
    axes[0].set_xlabel('Iteration')
    axes[0].set_ylabel('Determinant')
    axes[0].set_title('Determinant vs Iteration')
    axes[0].legend(fontsize=8, ncol=2)
    axes[0].grid(True, alpha=0.3)

    axes[1].axhline(target_entropy, color='black', linestyle='--', linewidth=2, label=f'Target={target_entropy:.4f}')
    axes[1].set_xlabel('Iteration')
    axes[1].set_ylabel('H(Gaussian) [nats]')
    axes[1].set_title('Gaussian Entropy vs Iteration')
    axes[1].legend(fontsize=8, ncol=2)
    axes[1].grid(True, alpha=0.3)

    axes[2].axhline(0, color='black', linestyle='--', linewidth=2, label='Target (gap=0)')
    axes[2].set_xlabel('Iteration')
    axes[2].set_ylabel('Gap [nats]')
    axes[2].set_title('Gap to Target vs Iteration')
    axes[2].legend(fontsize=8, ncol=2)
    axes[2].grid(True, alpha=0.3)

    plt.suptitle('Optimization Progress for Different Sigma Values', fontsize=14)
    plt.tight_layout()

    if output_file:
        plt.savefig(output_file, dpi=150, bbox_inches='tight')
        print(f"Saved: {output_file}")

    if show:
        plt.show()

    return fig


def plot_summary(summary_csv, output_file=None, show=True):
    """Plot summary bar charts comparing different sigma values."""
    df = pd.read_csv(summary_csv)

    fig, axes = plt.subplots(2, 2, figsize=(12, 10))

    sigmas = df['sigma'].values
    x = np.arange(len(sigmas))

    # Plot 1: Final Gap
    ax0 = axes[0, 0]
    colors = ['green' if g < 0.1 else 'orange' if g < 0.5 else 'red' for g in np.abs(df['gap'])]
    bars = ax0.bar(x, df['gap'], color=colors, alpha=0.7, edgecolor='black')
    ax0.axhline(0, color='black', linestyle='--', linewidth=1)
    ax0.set_xticks(x)
    ax0.set_xticklabels(sigmas)
    ax0.set_xlabel('Sigma')
    ax0.set_ylabel('Gap [nats]')
    ax0.set_title('Final Gap to Target Entropy')
    ax0.grid(True, alpha=0.3, axis='y')

    # Highlight best
    best_idx = np.argmin(np.abs(df['gap']))
    bars[best_idx].set_edgecolor('blue')
    bars[best_idx].set_linewidth(3)

    # Plot 2: Determinant Reduction
    ax1 = axes[0, 1]
    ax1.bar(x, df['det_reduction'], color='steelblue', alpha=0.7, edgecolor='black')
    ax1.set_xticks(x)
    ax1.set_xticklabels(sigmas)
    ax1.set_xlabel('Sigma')
    ax1.set_ylabel('Reduction Factor')
    ax1.set_title('Determinant Reduction (Initial / Final)')
    ax1.grid(True, alpha=0.3, axis='y')

    # Plot 3: Final Entropy
    ax2 = axes[1, 0]
    target = df['target_entropy'].iloc[0]
    ax2.bar(x, df['final_entropy'], color='coral', alpha=0.7, edgecolor='black')
    ax2.axhline(target, color='green', linestyle='--', linewidth=2, label=f'Target={target:.4f}')
    ax2.set_xticks(x)
    ax2.set_xticklabels(sigmas)
    ax2.set_xlabel('Sigma')
    ax2.set_ylabel('H(Gaussian) [nats]')
    ax2.set_title('Final Gaussian Entropy')
    ax2.legend()
    ax2.grid(True, alpha=0.3, axis='y')

    # Plot 4: Stage 1 Iterations
    ax3 = axes[1, 1]
    ax3.bar(x, df['stage1_iterations'], color='purple', alpha=0.7, edgecolor='black')
    ax3.set_xticks(x)
    ax3.set_xticklabels(sigmas)
    ax3.set_xlabel('Sigma')
    ax3.set_ylabel('Iterations')
    ax3.set_title('Stage 1 Iterations to Converge')
    ax3.grid(True, alpha=0.3, axis='y')

    plt.suptitle('Sigma Sweep Summary', fontsize=14)
    plt.tight_layout()

    if output_file:
        plt.savefig(output_file, dpi=150, bbox_inches='tight')
        print(f"Saved: {output_file}")

    if show:
        plt.show()

    return fig


def main():
    parser = argparse.ArgumentParser(description='Plot optimization results from CSV files')
    parser.add_argument('csv_file', nargs='?', help='CSV file to plot (single sigma history)')
    parser.add_argument('--all', metavar='CSV', help='Plot all sigmas from combined CSV')
    parser.add_argument('--summary', metavar='CSV', help='Plot summary bar charts')
    parser.add_argument('--output', '-o', help='Output file (PNG, PDF, etc.)')
    parser.add_argument('--no-show', action='store_true', help='Do not display plot')

    args = parser.parse_args()

    show = not args.no_show

    if args.summary:
        plot_summary(args.summary, output_file=args.output, show=show)
    elif args.all:
        plot_all_sigmas(args.all, output_file=args.output, show=show)
    elif args.csv_file:
        plot_single_sigma(args.csv_file, output_file=args.output, show=show)
    else:
        parser.print_help()


if __name__ == '__main__':
    main()
